''' 
Name: Google Earth Engine

Description: This script download dataset through Google Earth Engine to local folder.

Credentials: 
    Test: use credential from configuration_keys module
    Prod: check if a new credential will need to be create

Inputs: Geoserver connection details),( Database information

"Outputs: TIFF files"),(

"Author: Luis Zuravski"),(

"Created: 25/11/2020"

'''

import ee
import geemap
import os
import Utils.Config.configuration_keys as config_key

def downloadDatasets(data_catalog, date_start,date_end,lat,lon):
    # Change this for the specifc folder in the Geoserver
    download_path = "Downloads"
    out_dir = os.path.join(os.path.expanduser('~'),download_path)

    # loc = ee.Geometry.Point(lon),(lat)


    loc=ee.Geometry({"type":"Polygon","coordinates":[[[-6.549292537500002,52.437704617246],[-6.549292537500002,52.298931628224715],[-6.29042718105469,52.298931628224715],[-6.29042718105469,52.437704617246]]],"geodesic":False,"evenOdd":True})

    #polygon = ee.Geometry.Polygon[[[-6.37782096862793,52.3523807018953],[-6.37722015380859,52.3530622304732],[-6.37670516967773,52.3536913244486],[-6.37619018554687,52.3541631390539],[-6.37558937072754,52.3548970628732],[-6.37490272521973,52.3557358180288],[-6.3746452331543,52.3562076108085],[-6.37413024902344,52.3590906794698],[-6.3749885559082,52.3608728460197],[-6.37576103210449,52.3620783885164],[-6.37627601623535,52.3624976999357],[-6.37696266174316,52.3633363108363],[-6.37722015380859,52.3639652585661],[-6.37722015380859,52.3647514306377],[-6.37696266174316,52.3652755375801],[-6.37696266174316,52.3663237328124],[-6.37679100036621,52.3670050463769],[-6.37687683105469,52.3675815342629],[-6.37953758239746,52.3698874105766],[-6.38228416442871,52.3711975139489],[-6.38254165649414,52.3721931665239],[-6.38339996337891,52.3730839945403],[-6.38365745544434,52.3743940031011],[-6.38520240783691,52.3750751921967],[-6.38614654541016,52.3755991766591],[-6.38700485229492,52.374760798535],[-6.38794898986816,52.3739748045892],[-6.38889312744141,52.3732935985212],[-6.39026641845703,52.3724551766292],[-6.3914680480957,52.3718263497654],[-6.39241218566895,52.3717739471226],[-6.39352798461914,52.3720359597148],[-6.39464378356934,52.3725075784637],[-6.39515876770019,52.3731887966551],[-6.39610290527344,52.3740272046208],[-6.39824867248535,52.3745512015172],[-6.40030860900879,52.3744464026353],[-6.40168190002441,52.3740272046208],[-6.40202522277832,52.3736604030942],[-6.40374183654785,52.373345999361],[-6.405029296875,52.3730315933896],[-6.40631675720215,52.3732935985212],[-6.4076042175293,52.3733984001386],[-6.40872001647949,52.373345999361],[-6.40983581542969,52.3731363956288],[-6.41095161437988,52.3728219881653],[-6.41206741333008,52.3721407643164],[-6.41292572021484,52.3713547237424],[-6.4134407043457,52.3707782850975],[-6.41352653503418,52.370044625033],[-6.41412734985352,52.3696253852392],[-6.41481399536133,52.3693109527826],[-6.41558647155762,52.3689965180878],[-6.41773223876953,52.3689965180878],[-6.41970634460449,52.3687868937145],[-6.42082214355469,52.3685772683463],[-6.42228126525879,52.3682104215585],[-6.42374038696289,52.3674767188432],[-6.42374038696289,52.3664285509678],[-6.4240837097168,52.3655375887197],[-6.42434120178223,52.3644369634878],[-6.42511367797852,52.3633363108363],[-6.42545700073242,52.3623928724539],[-6.42640113830566,52.3609252615948],[-6.42897605895996,52.3578326362757],[-6.43077850341797,52.3561027684039],[-6.42374038696289,52.3562076108085],[-6.41979217529297,52.3560503471083],[-6.41867637634277,52.3560896630858],[-6.41470670700073,52.3557489234518],[-6.41234636306763,52.3555916581193],[-6.40869855880737,52.3555916581193],[-6.40846252441406,52.3556571854092],[-6.40689611434936,52.355683396298],[-6.40217542648315,52.3552902313344],[-6.40168190002441,52.3552902313344],[-6.40148878097534,52.3554606032481],[-6.39867782592773,52.355368864607],[-6.39462232589722,52.3557751342862],[-6.38964414596558,52.3556571854092],[-6.38934373855591,52.3555654471762],[-6.38895750045776,52.3556571854092],[-6.38593196868896,52.3554737087527],[-6.38442993164062,52.3551853867534],[-6.38327121734619,52.3547922173595],[-6.38144731521606,52.3541500331607],[-6.37988090515137,52.3535733700103],[-6.37837886810303,52.3527869990433],[-6.37782096862793,52.3523807018953]]]


    #loc =ee.Geometry(polygon, null, false) #ee.Geometry.Rectangle([-6.37782096862793,52.3523807018953,-6.37722015380859,52.3530622304732,-6.37837886810303,52.3527869990433,-6.37782096862793,52.3523807018953])

    collection = ee.ImageCollection(data_catalog).filterDate(date_start, date_end) \
        .filterBounds(loc) \
        .select(['B6','B5','B4','B3','B2'])
        #.filter(ee.Filter.listContains("system:band_names","N"))


    geemap.ee_export_image_collection(collection, out_dir=out_dir)

def main():
    
    # Use this credential only for test
    # *****************************************************

    service_account = config_key.googleEarthEngineServiceAccount
    json_file = config_key.googleEarthEngineJSON
    credentials = ee.ServiceAccountCredentials(service_account, json_file)

    # ***************************************************************************************

    # open web page to manualy authenticate
    #ee.Authenticate()
    ee.Initialize(credentials)

    # TODO get data from database requested in webpage
    data_catalog = 'COPERNICUS/S2_SR'
    date_start = '2020-11-01'
    date_end = '2020-11-07'
    lat = 52.3700496
    lon = -6.4174566

    downloadDatasets(data_catalog, date_start,date_end,lat,lon)
    
if __name__ == '__main__':
    main()
    print("Done!")